---
title: "ASM / Istio „Åß„ÇØ„É©„Çπ„ÇøÈñì„Éà„É©„Éï„Ç£„ÉÉ„ÇØ„ÇíÂà∂Âæ°„Åô„Çã"
emoji: "üê°"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: [gcp,istio]
published: false
---
ASM (Istio) „Åß„Éû„É´„ÉÅ„ÇØ„É©„Çπ„Çø„É°„ÉÉ„Ç∑„É•„ÇíÊßãÊàê„Åó„ÅüÈöõ„ÅÆ„Éà„É©„Éï„Ç£„ÉÉ„ÇØÂà∂Âæ°ÊñπÊ≥ï„Å´„Å§„ÅÑ„Å¶„ÅÆÊÉÖÂ†±„Çí„Åæ„Å®„ÇÅ„Å¶„Åø„Åæ„Åó„Åü„ÄÇ
# tl;dr
- 
- 

# „Å™„Åú„Éû„É´„ÉÅ„ÇØ„É©„Çπ„Çø„Åß„É°„ÉÉ„Ç∑„É•„ÇíÁµÑ„ÇÄ„ÅÆ„ÅãÔºü
‰ª•‰∏ã„Éâ„Ç≠„É•„É°„É≥„Éà„Å´Ë®òËºâ„Åï„Çå„Å¶„ÅÑ„Çã„Çà„ÅÜ„Å´„ÄÅ„Éû„É´„ÉÅ„ÇØ„É©„Çπ„Çø„ÇíÊßãÊàê„Åô„Çã„É¶„Éº„Çπ„Ç±„Éº„Çπ„ÅØËâ≤„ÄÖ„Å®ËÄÉ„Åà„Çâ„Çå„Åæ„Åô„Åå„ÄÅ
‰ªäÂõû„ÅÆ„Çà„ÅÜ„Å´„ÇØ„É©„Çπ„ÇøÈñì„Åß„Çµ„Éº„Éì„Çπ„É°„ÉÉ„Ç∑„É•„ÇíÊßãÊàê„Åô„Çã„Çà„ÅÜ„Å™Â†¥Âêà„ÅØ„ÄÅÂèØÁî®ÊÄß„ÅÆÂêë‰∏ä„Å®„ÅÑ„ÅÜ„ÅÆ„ÅåÁõÆÁöÑ„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Ç±„Éº„Çπ„ÅåÂ§ö„ÅÑ„Åã„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ
‰æã„Åà„Å∞Êù±‰∫¨„Å®Â§ßÈò™„Å´„Åù„Çå„Åû„Çå„ÇØ„É©„Çπ„Çø„Çí‰ΩúÊàê„Åó„Å¶„É™„Éº„Ç∏„Éß„É≥„É¨„Éô„É´„Åß„ÅÆÂÜóÈï∑ÊßãÊàê„Çí„Å®„Å£„Åü„Çä„ÄÅ„Ç™„É≥„Éó„É¨„Éü„Çπ-„ÇØ„É©„Ç¶„ÉâÈñì„ÇÑË§áÊï∞„ÇØ„É©„Ç¶„ÉâÈñì„ÅßÂÜóÈï∑ÊßãÊàê„Çí„Å®„Å£„Åü„Çä„Å™„Å©„Å™„Å©
https://cloud.google.com/anthos/multicluster-management/use-cases

„Éû„É´„ÉÅ„ÇØ„É©„Çπ„Çø„ÅÆÈñì„Åß„Çµ„Éº„Éì„Çπ„É°„ÉÉ„Ç∑„É•„ÇíÊßãÊàê„Åô„Çã„É°„É™„ÉÉ„Éà„Å®„Åó„Å¶„ÅØ„ÄÅ

# „Éû„É´„ÉÅ„ÇØ„É©„Çπ„ÇøÊßãÊàê‰æã
Istio „ÅØ„Éá„Éó„É≠„Ç§„É°„É≥„Éà„É¢„Éá„É´„ÅØ
https://istio.io/latest/docs/ops/deployment/deployment-models/

# „Éà„É©„Éï„Ç£„ÉÉ„ÇØ„ÅÆÂà∂Âæ°ÊñπÊ≥ï


# ÂÆüÈöõ„Å´Ë©¶„Åó„Å¶„Åø„Çã

## GKE „ÇØ„É©„Çπ„Çø‰ΩúÊàê
### Tokyo „ÇØ„É©„Çπ„Çø‰ΩúÊàê
```bash
export GCP_EMAIL_ADDRESS=$(gcloud auth list --filter=status:ACTIVE \
  --format="value(account)")
export PROJECT_ID=$(gcloud config list --format   "value(core.project)")
export PROJECT_NUMBER=$(gcloud projects describe ${PROJECT_ID}   --format="value(projectNumber)")
export CLUSTER_NAME=gke-tokyo
export CLUSTER_LOCATION=asia-northeast1-a

gcloud container clusters create ${CLUSTER_NAME} \
--zone ${CLUSTER_LOCATION} \
--num-nodes=5 \
--release-channel=regular
```

### Osaka „ÇØ„É©„Çπ„Çø‰ΩúÊàê
```bash
export GCP_EMAIL_ADDRESS=$(gcloud auth list --filter=status:ACTIVE \
  --format="value(account)")
export PROJECT_ID=$(gcloud config list --format   "value(core.project)")
export PROJECT_NUMBER=$(gcloud projects describe ${PROJECT_ID}   --format="value(projectNumber)")
export CLUSTER_NAME=gke-osaka
export CLUSTER_LOCATION=asia-northeast2-a

gcloud container clusters create ${CLUSTER_NAME} \
--zone ${CLUSTER_LOCATION} \
--num-nodes=5 \
--release-channel=regular
```

## ASM „Ç§„É≥„Çπ„Éà„Éº„É´
### asmcli „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
```bash
mkdir asm-multicluster && cd $_

curl https://storage.googleapis.com/csm-artifacts/asm/asmcli_1.12 > asmcli
chmod +x asmcli
```

### Tokyo „ÇØ„É©„Çπ„Çø„Å´ ASM „Çí„Ç§„É≥„Çπ„Éà„Éº„É´
```bash
export CLUSTER_NAME=gke-tokyo
export CLUSTER_LOCATION=asia-northeast1-a

./asmcli install \
  --project_id ${PROJECT_ID} \
  --cluster_name ${CLUSTER_NAME} \
  --cluster_location ${CLUSTER_LOCATION} \
  --fleet_id ${PROJECT_ID} \
  --output_dir ${CLUSTER_NAME} \
  --enable_all \
  --ca mesh_ca
```

### Osaka „ÇØ„É©„Çπ„Çø„Å´ ASM „Çí„Ç§„É≥„Çπ„Éà„Éº„É´
```bash
export CLUSTER_NAME=gke-osaka
export CLUSTER_LOCATION=asia-northeast2-a

./asmcli install \
  --project_id ${PROJECT_ID} \
  --cluster_name ${CLUSTER_NAME} \
  --cluster_location ${CLUSTER_LOCATION} \
  --fleet_id ${PROJECT_ID} \
  --output_dir ${CLUSTER_NAME} \
  --enable_all \
  --ca mesh_ca
```

### „Ç§„É≥„Çπ„Éà„Éº„É´„ÅÆÁ¢∫Ë™ç
```bash
${CLUSTER_NAME}/istioctl version

# client version: 1.12.0-asm.4
# control plane version: 1.12.0-asm.4
# data plane version: none
```

### „Éû„É´„ÉÅ„ÇØ„É©„Çπ„Çø„Ç§„É≥„Çπ„Éà„Éº„É´
https://cloud.google.com/service-mesh/docs/unified-install/gke-install-multi-cluster
```bash
kubectx gke-tokyo=gke_kuchima002_asia-northeast1-a_gke-tokyo
kubectx gke-osaka=gke_kuchima002_asia-northeast2-a_gke-osaka
```

```bash
export PROJECT_ID=$(gcloud config list --format   "value(core.project)")
export LOCATION_1=asia-northeast1-a
export CLUSTER_1=gke-tokyo
export LOCATION_2=asia-northeast2-a
export CLUSTER_2=gke-osaka

./asmcli create-mesh \
    ${PROJECT_ID} \
    ${PROJECT_ID}/${LOCATION_1}/${CLUSTER_1} \
    ${PROJECT_ID}/${LOCATION_2}/${CLUSTER_2}

```

### „Çµ„É≥„Éó„É´„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆ„Éá„Éó„É≠„Ç§
```bash
# „É©„Éô„É´„ÅÆÁ¢∫Ë™ç
kubectl -n istio-system get pods -l app=istiod --show-labels
# istiod-asm-1120-4-7986fbdf6b-cvl5p   1/1     Running   0          97m   app=istiod,istio.io/rev=asm-1120-4

kubectx gke-tokyo
kubectl create namespace sample
kubectl label namespace sample istio-injection- istio.io/rev=asm-1120-4 --overwrite
kubectl apply -f ${CLUSTER_NAME}/istio-1.12.0-asm.4/samples/helloworld/helloworld.yaml \
    -l service=helloworld -n sample
kubectl apply -f ${CLUSTER_NAME}/istio-1.12.0-asm.4/samples/helloworld/helloworld.yaml \
  -l version=v1 -n sample
kubectl get pods -n sample
# NAME                             READY   STATUS    RESTARTS   AGE
# helloworld-v1-776f57d5f6-m9mm9   2/2     Running   0          2m7s

kubectx gke-osaka
kubectl create namespace sample
kubectl label namespace sample istio-injection- istio.io/rev=asm-1120-4 --overwrite
kubectl apply -f ${CLUSTER_NAME}/istio-1.12.0-asm.4/samples/helloworld/helloworld.yaml \
    -l service=helloworld -n sample
kubectl apply -f ${CLUSTER_NAME}/istio-1.12.0-asm.4/samples/helloworld/helloworld.yaml \
  -l version=v2 -n sample
kubectl get pods -n sample
# NAME                            READY   STATUS    RESTARTS   AGE
# helloworld-v2-54df5f84b-vccq5   2/2     Running   0          47s

```

### sleep „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆ„Éá„Éó„É≠„Ç§
```bash
kubectx gke-tokyo
kubectl apply -f ${CLUSTER_NAME}/istio-1.12.0-asm.4/samples/sleep/sleep.yaml -n sample

kubectx gke-osaka
kubectl apply -f ${CLUSTER_NAME}/istio-1.12.0-asm.4/samples/sleep/sleep.yaml -n sample
```

### Helloworld „Çµ„Éº„Éì„Çπ„ÅÆÂëº„Å≥Âá∫„Åó
```bash
kubectl exec -n sample -c sleep \
    "$(kubectl get pod -n sample -l \
    app=sleep -o jsonpath='{.items[0].metadata.name}')" \
    -- curl -sS helloworld.sample:5000/hello

# Hello version: v1, instance: helloworld-v1-776f57d5f6-m9mm9
# Hello version: v2, instance: helloworld-v2-54df5f84b-vccq5
# Hello version: v1, instance: helloworld-v1-776f57d5f6-m9mm9
# Hello version: v2, instance: helloworld-v2-54df5f84b-vccq5
```

kubectl exec -n sample -c sleep \
    "$(kubectl get pod -n sample -l \
    app=sleep -o jsonpath='{.items[0].metadata.name}')" \
    -- curl -sS helloworld.sample.svc.cluster.local:5000/hello
‚Üí ‰∫§‰∫í„Å´ÂêÑ„ÇØ„É©„Çπ„Çø„Å´„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Çã



```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: helloworld
spec:
  host: helloworld.sample.svc.cluster.local
  trafficPolicy:
    connectionPool:
      http:
        maxRequestsPerConnection: 1
    loadBalancer:
      simple: ROUND_ROBIN
      localityLbSetting:
        enabled: true
    outlierDetection:
      consecutive5xxErrors: 1
      interval: 1s
      baseEjectionTime: 1m
```

```bash
cat << EOF > dr-failover.yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: helloworld
spec:
  host: helloworld.sample.svc.cluster.local
  trafficPolicy:
    connectionPool:
      http:
        maxRequestsPerConnection: 1
    loadBalancer:
      simple: ROUND_ROBIN
      localityLbSetting:
        enabled: true
    outlierDetection:
      consecutive5xxErrors: 1
      interval: 1s
      baseEjectionTime: 1m
EOF


kubectl apply -f dr-failover.yaml -n sample
```

$ kubectl exec -n sample -c sleep \
>     "$(kubectl get pod -n sample -l \
>     app=sleep -o jsonpath='{.items[0].metadata.name}')" \
>     -- curl -sS helloworld.sample:5000/hello
Hello version: v2, instance: helloworld-v2-54df5f84b-vccq5
kuchima@cloudshell:~/asm-multicluster (kuchima002)$ kubectl exec -n sample -c sleep     "$(kubectl get pod -n sample -l \
    app=sleep -o jsonpath='{.items[0].metadata.name}')"     -- curl -sS helloworld.sample:5000/hello
Hello version: v2, instance: helloworld-v2-54df5f84b-vccq5
kuchima@cloudshell:~/asm-multicluster (kuchima002)$ kubectl exec -n sample -c sleep     "$(kubectl get pod -n sample -l \
    app=sleep -o jsonpath='{.items[0].metadata.name}')"     -- curl -sS helloworld.sample:5000/hello
Hello version: v2, instance: helloworld-v2-54df5f84b-vccq5


### „É≠„Éº„Ç´„É´„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆ Proxy „Çí Drain „Åó„Å¶„Åø„Çã
```bash
kubectl  exec \
  "$(kubectl get pod -n sample -l app=helloworld \
  -o jsonpath='{.items[0].metadata.name}')" \
  -n sample -c istio-proxy -- curl -sSL -X POST 127.0.0.1:15000/drain_listeners
```
$ kubectl exec -n sample -c sleep     "$(kubectl get pod -n sample -l \
    app=sleep -o jsonpath='{.items[0].metadata.name}')"     -- curl -sS helloworld.sample:5000/hello
Hello version: v1, instance: helloworld-v1-776f57d5f6-m9mm9
kuchima@cloudshell:~/asm-multicluster (kuchima002)$ kubectl exec -n sample -c sleep     "$(kubectl get pod -n sample -l \
    app=sleep -o jsonpath='{.items[0].metadata.name}')"     -- curl -sS helloworld.sample:5000/hello
Hello version: v1, instance: helloworld-v1-776f57d5f6-m9mm9
kuchima@cloudshell:~/asm-multicluster (kuchima002)$ kubectl exec -n sample -c sleep     "$(kubectl get pod -n sample -l \
    app=sleep -o jsonpath='{.items[0].metadata.name}')"     -- curl -sS helloworld.sample:5000/hello
Hello version: v1, instance: helloworld-v1-776f57d5f6-m9mm9

‚Üí„Å°„ÇÉ„Çì„Å® Fail Over „Åó„Åü

```bash
cat << EOF > dr-distribution.yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: helloworld
spec:
  host: helloworld.sample.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      localityLbSetting:
        enabled: true
        distribute:
        - from: asia-northeast1/*
          to:
            "asia-northeast1/*": 50
            "asia-northeast2/*": 50
    outlierDetection:
      consecutive5xxErrors: 1
      interval: 1s
      baseEjectionTime: 1m
EOF


kubectl apply -f dr-distribution.yaml -n sample
```

### Node „ÅÆ„É™„Éº„Ç∏„Éß„É≥/„Çæ„Éº„É≥„ÇíÁ¢∫Ë™ç
```bash
$ kubectl describe nodes gke-gke-osaka-default-pool-a2626c2f-05m4
Name:               gke-gke-osaka-default-pool-a2626c2f-05m4
Roles:              <none>
Labels:             beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/instance-type=e2-medium
                    beta.kubernetes.io/os=linux
                    cloud.google.com/gke-boot-disk=pd-standard
                    cloud.google.com/gke-container-runtime=containerd
                    cloud.google.com/gke-nodepool=default-pool
                    cloud.google.com/gke-os-distribution=cos
                    cloud.google.com/machine-family=e2
                    failure-domain.beta.kubernetes.io/region=asia-northeast2
                    failure-domain.beta.kubernetes.io/zone=asia-northeast2-a
                    kubernetes.io/arch=amd64
                    kubernetes.io/hostname=gke-gke-osaka-default-pool-a2626c2f-05m4
                    kubernetes.io/os=linux
                    node.kubernetes.io/instance-type=e2-medium
                    topology.gke.io/zone=asia-northeast2-a
                    topology.kubernetes.io/region=asia-northeast2
                    topology.kubernetes.io/zone=asia-northeast2-a
```

Distribute „ÅÆÂâ≤Âêà„Å´Âøú„Åò„Å¶ÊåØ„ÇäÂàÜ„Åë„ÄÇ0:100% „ÅßÊåØ„ÇäÂàÜ„Åë„Åü„Å®„Åç„Å´ v1 ÂÅ¥„ÇíËêΩ„Å®„Åô„Å®„ÄÅv2 ÂÅ¥„Å´ Failover „Åô„ÇãÂãï„Åç„Å´„Å™„Çã
kuchima@cloudshell:~/asm-multicluster$ kubectl get pods -n sample
NAME                             READY   STATUS    RESTARTS   AGE
helloworld-v1-776f57d5f6-m9mm9   1/2     Running   0          15h
sleep-557747455f-qct2x           2/2     Running   0          15h
kuchima@cloudshell:~/asm-multicluster$ kubectl exec -n sample -c sleep     "$(kubectl get pod -n sample -l \
    app=sleep -o jsonpath='{.items[0].metadata.name}')"     -- curl -sS helloworld.sample:5000/hello
Hello version: v2, instance: helloworld-v2-54df5f84b-bpnb8
kuchima@cloudshell:~/asm-multicluster$ kubectl exec -n sample -c sleep     "$(kubectl get pod -n sample -l \
    app=sleep -o jsonpath='{.items[0].metadata.name}')"     -- curl -sS helloworld.sample:5000/hello
Hello version: v2, instance: helloworld-v2-54df5f84b-bpnb8
kuchima@cloudshell:~/asm-multicluster$ kubectl exec -n sample -c sleep     "$(kubectl get pod -n sample -l \
    app=sleep -o jsonpath='{.items[0].metadata.name}')"     -- curl -sS helloworld.sample:5000/hello
Hello version: v2, instance: helloworld-v2-54df5f84b-bpnb8

‰ªñ„ÇØ„É©„Çπ„Çø Pod „Å∏„ÅÆ Egress „Çí Network Policy „ÅßÂ∞Å„Åò„Å¶„Åø„Çã
```bash
cat << EOF > disallow-gkeosaka.yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
spec:
  podSelector: 
    matchLabels:
      app: sleep
  policyTypes:
  - Egress
  egress:
  - to:
    - ipBlock:
        cidr: 10.52.0.0/14 # gke-tokyo „ÅÆ Pod IP range
EOF

kubectl apply -f disallow-gkeosaka.yaml -n sample
```
‚Üí Network Policy „ÅØÊó¢Â≠ò„Ç≥„Éç„ÇØ„Ç∑„Éß„É≥„ÇíÊ≠¢„ÇÅ„Çâ„Çå„Å™„ÅÑ
‚Üí VPC FW „Åß„Éé„Éº„Éâ„Éó„Éº„É´Âçò‰Ωç„ÅßÊ≠¢„ÇÅ„Çã„ÅÆ„ÅØOK


kubectl exec -n sample -c sleep     "$(kubectl get pod -n sample -l app=sleep -o jsonpath='{.items[0].metadata.name}')"     -- curl -sS helloworld.sample:5000/hello




```yaml
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: helloworld-subsets
spec:
  host: helloworld.sample.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2

```

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: helloworld
spec:
  hosts:
  - helloworld.sample.svc.cluster.local
  http:
  - route:
    - destination:
        host: helloworld.sample.svc.cluster.local
        subset: v1
      weight: 100
    - destination:
        host: helloworld.sample.svc.cluster.local
        subset: v2
      weight: 0
```

```bash
$ kubectl exec -n sample -c sleep     "$(kubectl get pod -n sample -l app=sleep -o jsonpath='{.items[0].metadata.name}')"     -- curl -sS helloworld.sample:5000/hello
no healthy upstream
```
‚Üí Locality Balancing „Å®„ÅØÈÅï„Å£„Å¶„ÄÅË≤†Ëç∑ÂàÜÊï£ÂÖà„Å´ weight:0 „ÅÆ„Çµ„Éº„Éì„Çπ„ÇíË®≠ÂÆö„Åó„Å™„ÅÑÂãï„Åç
### ÔºàÂèÇËÄÉÔºâMCS„ÇíÊúâÂäπ„Å´„Åó„ÅüÂ†¥Âêà„ÅÆ„É≠„Éº„Ç´„É´„ÇØ„É©„Çπ„Çø„Ç¢„ÇØ„Çª„Çπ
1.12 „Åã„Çâ„ÅØ MCS ÊúâÂäπÂåñÊôÇ„Å´„Åä„ÅÑ„Å¶ cluster.local „Å´„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Å®„ÄÅ„É≠„Éº„Ç´„É´„ÇØ„É©„Çπ„Çø„ÅÆ„Åø„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Çà„ÅÜ„Å´„Å™„Çã„Çâ„Åó„ÅÑ