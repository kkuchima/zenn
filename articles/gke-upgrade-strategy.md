---
title: "GKE のアップグレード戦略を考える"
emoji: "🐲"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [GCP, GoogleCloud, GKE]
publication_name: "google_cloud_jp"
published: false
---
GKE のアップグレード戦略を

* ノード
* ネットワーク
* ストレージ
* オブザーバビリティ

※本記事で紹介する各機能・サービスの [Product launch stages](https://cloud.google.com/products#product-launch-stages)(GA, Preview) は記事執筆時点のものです

# tl;dr
* 


### 自動アップグレード
Kubernetes クラスタの運用の中でも特に負荷が高い作業がクラスタのアップグレードではないでしょうか。  
Kubernetes / GKE では脆弱性の対応や既知問題の修正、新機能の導入のためにアップデートを頻繁にリリースしています。リリースサイクルの早さはセキュリティ対策や新機能利用の観点から有難い反面、運用を担当している方にとっては辛みにもなっている部分かと思います。  

GKE はこのアップグレードの運用負荷を低減するための機能を提供しています。  

#### リリースチャンネル
GKE の Control Plane は Google 管理なので、利用者側でアップグレード作業をする必要はありません。  
一方 Node については手動でのアップグレードもできますが、リリースチャンネルという仕組みを使って自動的にアップグレードができます。Autopilot クラスタはリリースチャンネルに自動的に登録されます。  

リリースチャンネルはバージョニングとアップグレードを行う際のベストプラクティスを提供する仕組みです。リリースチャンネルにクラスタを登録すると、 Google により Control Plane だけでなく Node のバージョンとアップグレードサイクルも自動的に管理されるようになります。  

リリースチャンネルは、利用できる機能や安定性の異なる以下 3 種類のチャンネルを提供しています。利用環境や求められる安定性等に応じて使い分けることが可能です。  
* **Rapid** ... 最新のバージョンが利用可能。検証目的での利用を推奨 (SLA 対象外)。
* **Regular** ... 機能の可用性とリリースの安定性のバランスが取れている。
* **Stable** ... 最も安定したバージョンを提供。新機能よりも安定性を優先するケースで採用。
 

#### 自動アップグレードタイミングの制御
自動アップグレード自体は便利な機能ですが、クラスタが知らないうちにアップグレードされると困るという場合もあるのではないでしょうか。GKE では自動アップグレードのタイミングをコントロールする仕組みも提供しています。  

GKE の[メンテナンスの時間枠](https://cloud.google.com/kubernetes-engine/docs/concepts/maintenance-windows-and-exclusions#maintenance_windows)という設定をしていただくことで、アップグレードなど自動メンテナンスを**許可**する時間枠を設定できます。また[メンテナンスの除外](https://cloud.google.com/kubernetes-engine/docs/concepts/maintenance-windows-and-exclusions#exclusions)を設定することにより、自動メンテナンスを**禁止**する期間間も指定できます。  

* **メンテナンスの時間枠** ... 自動メンテナンスを許可する時間枠を設定。営業時間・ピーク時間帯を避けてアップグレードしてほしいケースやオンコール対応のしやすさなどから日中の業務時間帯にアップグレードをしてほしいケース等で利用
* **メンテナンスの除外** ... 自動メンテナンスを禁止する時間枠を設定。大型イベント期間中や人手が足りない時期などアップグレードをしてほしくない期間を設定するケース等で利用。マイナーバージョンのアップグレード (例：1.22 -> 1.23) を最大 180 日間[^1]停止することも可能

これらの機能を活用することにより、自動アップグレードによる思わぬサービス影響を抑えたり、人員の不足やイベントの期間中等を避けたりと、より安全なタイミングでアップグレードができるよう制御することが可能になります。  

また、[ロールアウトシーケンス](https://cloud.google.com/kubernetes-engine/docs/concepts/about-rollout-sequencing?hl=ja)という機能を活用することにより、複数クラスタ間での自動アップグレードの順序を制御することもできます。  
例えば、開発環境→ステージング環境→本番環境 という順番で自動アップグレードと検証を行うことで、より安全に本番環境をアップグレードできるようになります。
![ロールアウトシーケンスの例](images/rollout-sequencing.png)

[^1]: リリースチャンネルに登録されているクラスタが対象。また、マイナーバージョンの EOL を超過することはできない。

#### アップグレードに影響のある構成 / API 利用の検知
また、GKE には今後のマイナー バージョンでサポートされない構成や Kubernetes API がクラスタで利用されていることを自動的に検出し通知する Deprecation Insights という機能も提供しています。  
例えば Deprecation Insights では以下のような Deprecation を自動的に検出することが可能です。
* 1.25 で削除される Kubernetes API の利用
* 1.25 で削除されるリソース (PodSecurityPolicy) の利用
* 1.24 でサポートされなくなる Docker ベースのノードイメージの利用

この機能により、次バージョンで削除予定の API の利用やサポートされない構成が検知されるとマイナーバージョンの自動アップグレードが一時停止される挙動となるため、知らないうちにクラスタがアップグレードされて手元のマニフェストと互換性がなくなっていた、というようなトラブルの発生を防ぐことが期待できます (ただし、各マイナーバージョンの EOL を過ぎた場合は強制的にアップグレードされてしまいます)。  


# ノード



# まとめ
